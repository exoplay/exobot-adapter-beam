{"version":3,"sources":["webpack:///webpack/bootstrap 55a292faaf35ccc407b9","webpack:///external \"@exoplay/exobot\"","webpack:///external \"beam-client-node\"","webpack:///external \"beam-client-node/lib/ws\"","webpack:///./beam.js"],"names":["EVENTS","ChatMessage","BeamAdapter","username","password","arguments","userCache","joinChannel","res","beamUser","body","client","chat","join","channel","id","createSocket","response","userId","channelId","endpoints","endpoitns","authKey","socket","boot","Object","keys","forEach","beamEvent","mappedFn","on","args","bind","bot","emitter","emit","auth","authkey","then","status","Adapter","STATUS","CONNECTED","name","log","notice","catch","err","error","ERROR","use","attempt","message","debug","text","call","txt","msg","user_id","user_name","roles","level","user","user_roles","content","buildUser","cacheUser","getUser","filter","m","type","whisper","receive","find","u","request","qs","where","e","warn","roleMapping","adapterUsers","role","map","adapterUserId","adapterUser"],"mappings":"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","file":"beam.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// identity function for calling harmony imports with the correct context\n \t__webpack_require__.i = function(value) { return value; };\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 3);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 55a292faaf35ccc407b9","module.exports = require(\"@exoplay/exobot\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"@exoplay/exobot\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"beam-client-node\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"beam-client-node\"\n// module id = 1\n// module chunks = 0","module.exports = require(\"beam-client-node/lib/ws\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"beam-client-node/lib/ws\"\n// module id = 2\n// module chunks = 0","import BeamClient from 'beam-client-node';\nimport BeamSocket from 'beam-client-node/lib/ws';\n\nimport { Adapter, User } from '@exoplay/exobot';\n\nexport const EVENTS = {\n  ChatMessage: 'beamMessage',\n  //UserJoin: 'beamPresence',\n};\n\nexport default class BeamAdapter extends Adapter {\n  static type = 'beam';\n\n  userCache = {};\n\n  constructor ({ username, password }) {\n    super(...arguments);\n    this.username = username;\n    this.password = password;\n  }\n\n  register (bot) {\n    super.register(...arguments);\n    const { username, password } = this;\n\n    if (!username || !password) {\n      this.status = Adapter.STATUS.ERROR;\n      bot.log.error('username and password are required to connect to Beam.');\n      return;\n    }\n\n    let userInfo;\n\n    this.client = new BeamClient();\n    this.client.use('password', {\n        username,\n        password\n      })\n      .attempt()\n      .then(this.joinChannel)\n      .then(this.createSocket)\n      .catch(err => {\n        bot.log.error(err);\n      });\n  }\n\n  joinChannel = res => {\n    this.beamUser = res.body;\n    return this.client.chat.join(res.body.channel.id);\n  }\n\n  createSocket = res => {\n    const body = response.body;\n\n    const userId = this.beamUser.id;\n    const channelId = this.beamUser.channel.id;\n    const endpoints = body.endpoitns;\n    const authKey = body.authKey;\n\n    this.socket = new BeamSocket(endpoints).boot();\n\n    Object.keys(EVENTS).forEach(beamEvent => {\n      const mappedFn = this[EVENTS[beamEvent]];\n      this.socket.on(beamEvent, (...args) => mappedFn.bind(this)(...args));\n      this.socket.on(beamEvent, (...args) => {\n        this.bot.emitter.emit(`beam-${beamEvent}`, ...args);\n      });\n    });\n\n    return this.socket.auth(channelId, userId, authkey).then(() => {\n      this.status = Adapter.STATUS.CONNECTED;\n\n      this.bot.emitter.emit('connected', this.name);\n      this.bot.log.notice('Connected to Beam.');\n    }).catch(err => this.bot.log.error(err));\n  }\n\n  send (message) {\n    this.bot.log.debug(`Sending ${message.text} to ${message.channel}`);\n    this.socket.call('msg', [message.txt]);\n  }\n\n  buildUser (msg) {\n    return {\n      id: msg.user_id,\n      username: msg.user_name,\n      roles: msg.roles,\n      level: msg.level,\n    };\n  }\n\n  cacheUser (user) {\n    this.userCache[user.id] = {\n      ...this.userCache[user.id],\n      ...user,\n    };\n  }\n\n  async beamMessage (msg) {\n    const { user_name, user_id, channel, user_roles } = msg;\n    if (user_name === this.beamUser.user_name) { return; }\n    this.bot.log.debug(content);\n\n    const beamUser = this.buildUser(msg);\n    this.cacheUser(beamUser);\n\n    const user = await this.getUser(user_id, user_name, beamUser);\n\n    msg.message.filter(m => m.type === 'text').forEach(m => {\n      if (m.whisper) {\n        return super.receiveWhisper({ user, text: m.text, channel });\n      }\n\n      this.receive({ user, text: m.text, channel });\n    });\n  }\n\n  async getUserIdByUserName (name) {\n    let user = this.userCache.find(u => u.username === name);\n    if (user) { return user.id; }\n\n    try {\n      const res = await this.client.request('/GET', 'users/search', {\n        qs: {\n          where: `username:eq:${name}`\n        }\n      });\n\n      if (res.body && res.body[0] && res.body[0].id) {\n        this.cacheUser({\n          id: res.body[0].id,\n          name\n        });\n\n        return res.body[0].id;\n      } else {\n        return;\n      }\n    } catch (e) {\n      this.bot.log.warn(e);\n    }\n  }\n\n  getRoleIdByRoleName (name) {\n    return name;\n  }\n\n  getRolesForUser (userId) {\n    if (this.roleMapping && this.adapterUsers && this.adapterUsers[userId]) {\n      return this.adapterUsers[userId].roles\n        .filter(role => this.roleMapping[role])\n        .map(role => this.roleMapping[role]);\n    }\n\n    return [];\n  }\n\n  getRoles(adapterUserId, adapterUser) {\n    if (adapterUser.roles) {\n      return adapterUser.roles.map(role => role.name);\n    }\n\n    return false;\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./beam.js"],"sourceRoot":""}